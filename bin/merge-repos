#!/bin/bash

set -xue -o pipefail

cd $HOME
NEW_REPO=matisse-new
TMP_REPO=/tmp/tmp-git-repo

function make_new_repo {
    # Initialize new repository
    rm -rf $NEW_REPO
    git clone ~/matisse $NEW_REPO
    cd $NEW_REPO
    rm -rf .gitmodules
    rmdir arium-dashboards reinsurance-standalone adminpanel-starter
    git add -A .
    git commit -m 'MERGE-REPOS: Remove git submodules'

    # For each repo, clone the repo, move contents to a subdir with same name, then merge into merged repo
    for repo in matisse-frontend matisse-backend; do
        remote="git@github.com:analyzere/${repo}.git"
        rm -rf $TMP_REPO
        git clone --branch master $remote $TMP_REPO
        cd $TMP_REPO
        if [ $repo == "matisse-frontend" ]; then
            git rm -rf apps/cap && git commit -m 'Delete caps app'
            git filter-repo \
                --path app/ \
                --path src/ \
                --path apps/cap/ \
                --path UserGuide.pdf \
                --path data/ \
                --path src/data/ \
                --path src/app/lib/d3-v3/d3.v3.min.js \
                --path src/assets/data/ \
                --path q \
                --path yarn.lock \
                --invert-paths --force
        elif [ $repo == "matisse-backend" ]; then
            git filter-repo \
                --path src/main/java/are/ \
                --invert-paths --force
        fi
        git filter-repo --to-subdirectory-filter $repo

        cd $NEW_REPO
        git pull $TMP_REPO master --allow-unrelated-histories --no-edit
    done
    cd $HOME/matisse-new
}

function aggressive_gc {
    # Delete references to the old history
    git for-each-ref --format='delete %(refname)' refs/original | git update-ref --stdin
    # Flag all deleted objects for garbarage collection
    git reflog expire --expire=now --all
    # Garbage collect
    git gc --prune=now
}

make_new_repo
aggressive_gc
git-big-files
echo "DISK USAGE: $(du -sh .)"
